name: ðŸš¨ Daily Health Check

# ExÃ©cute un check quotidien pour dÃ©tecter les problÃ¨mes
on:
  schedule:
    - cron: '0 9 * * 1-5'  # Tous les jours ouvrÃ©s Ã  9h UTC
  workflow_dispatch:  # Permettre exÃ©cution manuelle

jobs:
  daily-check:
    name: ðŸ¥ Project Health Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'
        
    - name: ðŸ“¦ Install dependencies
      run: npm ci
      
    - name: ðŸ” Full project audit
      run: |
        echo "## ðŸ¥ Daily Health Report - $(date)" >> $GITHUB_STEP_SUMMARY
        
        # Dependencies audit
        echo "### ðŸ“¦ Dependencies" >> $GITHUB_STEP_SUMMARY
        if npm audit --audit-level=moderate; then
          echo "âœ… No security vulnerabilities" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Security vulnerabilities detected" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Outdated packages
        echo "### ðŸ“… Package Updates" >> $GITHUB_STEP_SUMMARY
        OUTDATED=$(npm outdated --depth=0 | wc -l)
        if [ "$OUTDATED" -gt 1 ]; then
          echo "ðŸ“Š $((OUTDATED-1)) packages can be updated" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… All packages up to date" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: ðŸ§¹ Cleanup verification
      run: |
        if [ -f "./scripts/audit-backup-files.sh" ]; then
          chmod +x ./scripts/audit-backup-files.sh
          ./scripts/audit-backup-files.sh
        fi
        
    - name: ðŸ—ï¸ Build test
      run: npm run build
      env:
        CI: true
        
    - name: ðŸ“Š Project metrics
      run: |
        echo "### ðŸ“Š Project Metrics" >> $GITHUB_STEP_SUMMARY
        
        # Lines of code
        LOC=$(find src -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" | xargs wc -l | tail -1 | awk '{print $1}')
        echo "ðŸ“ Lines of code: $LOC" >> $GITHUB_STEP_SUMMARY
        
        # Number of components
        COMPONENTS=$(find src -name "*.tsx" | wc -l)
        echo "ðŸ§© React components: $COMPONENTS" >> $GITHUB_STEP_SUMMARY
        
        # Build size
        if [ -d ".next" ]; then
          BUILD_SIZE=$(du -sh .next | cut -f1)
          echo "ðŸ“¦ Build size: $BUILD_SIZE" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "âœ… **Health check completed**" >> $GITHUB_STEP_SUMMARY
