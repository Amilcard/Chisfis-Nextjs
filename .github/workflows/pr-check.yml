name: ðŸ” PR Quality Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-check:
    name: ðŸ§ª PR Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout PR
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'
        
    - name: ðŸ“¦ Install dependencies
      run: npm ci
      
    - name: ðŸ§¹ Pre-build cleanup
      run: |
        if [ -f "./scripts/prebuild-cleanup.sh" ]; then
          chmod +x ./scripts/prebuild-cleanup.sh
          ./scripts/prebuild-cleanup.sh
        fi
        
    - name: ðŸ” Comprehensive audit
      run: |
        echo "## ðŸ” PR Quality Report" >> $GITHUB_STEP_SUMMARY
        
        # Check for backup files
        if [ -f "./scripts/audit-backup-files.sh" ]; then
          chmod +x ./scripts/audit-backup-files.sh
          if ./scripts/audit-backup-files.sh; then
            echo "âœ… No backup files detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Backup files found - please clean" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        # Check for large files
        echo "### ðŸ“ Large Files Check" >> $GITHUB_STEP_SUMMARY
        if find . -size +5M -not -path "./node_modules/*" -not -path "./.git/*" -not -path "./.next/*" | grep -q .; then
          echo "âš ï¸ Large files detected:" >> $GITHUB_STEP_SUMMARY
          find . -size +5M -not -path "./node_modules/*" -not -path "./.git/*" -not -path "./.next/*" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… No large files" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: ðŸ”§ ESLint check
      run: npm run lint
      
    - name: ðŸ—ï¸ Build verification
      run: npm run build
      env:
        CI: true
        
    - name: ðŸ“Š Bundle analysis
      run: |
        echo "### ðŸ“Š Build Analysis" >> $GITHUB_STEP_SUMMARY
        if [ -d ".next" ]; then
          BUILD_SIZE=$(du -sh .next | cut -f1)
          echo "ðŸ“¦ Build size: $BUILD_SIZE" >> $GITHUB_STEP_SUMMARY
          
          # Count pages
          if [ -d ".next/server/pages" ] || [ -d ".next/server/app" ]; then
            PAGE_COUNT=$(find .next/server -name "*.js" -o -name "*.html" | wc -l)
            echo "ðŸ“„ Pages generated: $PAGE_COUNT" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        echo "âœ… **PR Ready for Review**" >> $GITHUB_STEP_SUMMARY
